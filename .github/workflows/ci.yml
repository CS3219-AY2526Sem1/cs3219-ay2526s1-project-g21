name: ci
on:
  push:
    branches: ["main"]
  pull_request:
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [services/collab, services/match, services/question, services/user, services/sandbox]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Type check and lint ${{ matrix.service }}
        uses: golangci/golangci-lint-action@v5
        with:
          version: v1.64.8
          working-directory: ${{ matrix.service }}
          args: --timeout=5m --out-format=colored-line-number

      - name: Test ${{ matrix.service }}
        run: |
          echo "==> go test ${{ matrix.service }}"
          (cd "${{ matrix.service }}" && go test ./...)

  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build images (no push)
        run: |
          for d in services/*; do
            name=$(basename "$d")
            docker build -t peerprep/$name:ci "$d"
          done
